# 新規項目追加機能のデータフロー

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                          Frontend (React)                        │
│                                                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Dashboard Component                          │  │
│  │                                                            │  │
│  │  ┌─────────────────────────────────────────────────────┐ │  │
│  │  │  [新規追加] Button                                  │ │  │
│  │  └─────────────────┬───────────────────────────────────┘ │  │
│  │                    │ onClick                              │  │
│  │                    ▼                                      │  │
│  │  ┌─────────────────────────────────────────────────────┐ │  │
│  │  │  AddDetailDialog Component                          │ │  │
│  │  │                                                      │ │  │
│  │  │  [ユーザー名]  _________________________            │ │  │
│  │  │  [カテゴリ]    [家賃 ▼]                            │ │  │
│  │  │  [備考]        _________________________            │ │  │
│  │  │  [金額]        _____________________ 円             │ │  │
│  │  │                                                      │ │  │
│  │  │  [追加する] [キャンセル]                            │ │  │
│  │  └────────────────┬────────────────────────────────────┘ │  │
│  └───────────────────┼──────────────────────────────────────┘  │
│                      │ onSubmit                                 │
│                      ▼                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  useCreateCost Hook (React Query)                       │   │
│  │  - Form validation (Zod)                                │   │
│  │  - Cache invalidation                                   │   │
│  └────────────────┬────────────────────────────────────────┘   │
│                   │                                             │
│                   ▼                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  createCostDetail Server Function                       │   │
│  │  (TanStack Start)                                       │   │
│  └────────────────┬────────────────────────────────────────┘   │
└───────────────────┼──────────────────────────────────────────┘
                    │ HTTP POST
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                 Backend API (Hono + Lambda)                      │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  POST /cost/create Endpoint                             │    │
│  │  - Request validation (zValidator)                      │    │
│  └────────────────┬────────────────────────────────────────┘    │
│                   │                                              │
│                   ▼                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  createCostHandler                                      │    │
│  └────────────────┬────────────────────────────────────────┘    │
│                   │                                              │
│                   ▼                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  costService.createCostDetail                           │    │
│  │  - Business validation                                  │    │
│  │  - Price >= 0                                           │    │
│  │  - Memo <= 500 chars                                    │    │
│  │  - UserId not empty                                     │    │
│  └────────────────┬────────────────────────────────────────┘    │
│                   │                                              │
│                   ▼                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  costDataRepository.createCostData                      │    │
│  │  - Generate timestamp                                   │    │
│  │  - Calculate YearMonth                                  │    │
│  │  - Build DynamoDB item                                  │    │
│  └────────────────┬────────────────────────────────────────┘    │
│                   │                                              │
└───────────────────┼──────────────────────────────────────────────┘
                    │ DynamoDB PutCommand
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                        DynamoDB                                  │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Table: LineBotTable                                    │    │
│  │                                                          │    │
│  │  Item:                                                  │    │
│  │  {                                                      │    │
│  │    PK: "USER#****"                                    │    │
│  │    SK: "COST#1729681234567"                             │    │
│  │    GSI1PK: "COST#2025-10"                               │    │
│  │    GSI1SK: "USER#****#1729681234567"                  │    │
│  │    EntityType: "COST_DATA"                              │    │
│  │    User: "****"                                        │    │
│  │    Category: "rent"                                     │    │
│  │    Memo: "10月分家賃"                                    │    │
│  │    Price: 100000                                        │    │
│  │    Timestamp: 1729681234567                             │    │
│  │    YearMonth: "2025-10"                                 │    │
│  │    CreatedAt: "2025-10-23T10:34:01.000Z"                │    │
│  │    UpdatedAt: "2025-10-23T10:34:01.000Z"                │    │
│  │  }                                                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                    │ Success Response
                    ▼
                [Response flows back through the layers]
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                          Frontend                                │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  React Query Cache Invalidation                         │    │
│  │  - Invalidate: ["monthly", "cost", "2025", "10"]       │    │
│  └────────────────┬────────────────────────────────────────┘    │
│                   │                                              │
│                   ▼                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  Refetch Monthly Data                                   │    │
│  │  GET /dashboard/monthly?year=2025&month=10              │    │
│  └────────────────┬────────────────────────────────────────┘    │
│                   │                                              │
│                   ▼                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  UI Update                                              │    │
│  │  - Toast: "新しい項目が追加されました"                    │    │
│  │  - Dialog closes                                        │    │
│  │  - Dashboard table updates with new item                │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

## データフローの詳細

### 1. ユーザー入力
1. ユーザーが「新規追加」ボタンをクリック
2. AddDetailDialog が表示される
3. フォームに入力:
   - ユーザー名: "****"
   - カテゴリ: "家賃"（内部値: "rent"）
   - 備考: "10月分家賃"
   - 金額: 100000

### 2. クライアント側処理
1. フォームバリデーション（Zod）
   - 必須項目チェック
   - データ型チェック
2. useCreateCost hook呼び出し
3. createCostDetail server function実行

### 3. HTTP リクエスト
```http
POST /cost/create
Content-Type: application/json

{
  "userId": "****",
  "category": "rent",
  "memo": "10月分家賃",
  "price": 100000
}
```

### 4. バックエンド処理
1. zValidator による入力検証
2. createCostHandler 実行
3. costService でビジネスロジック検証
4. costDataRepository でデータ変換とDynamoDB保存

### 5. DynamoDB 保存
- タイムスタンプ生成: `1729681234567`
- YearMonth計算: `"2025-10"`
- キー生成:
  - PK: `USER#****`
  - SK: `COST#1729681234567`
  - GSI1PK: `COST#2025-10`
  - GSI1SK: `USER#****#1729681234567`

### 6. レスポンスとUI更新
1. DynamoDB から作成されたアイテムを返却
2. React Query がキャッシュを無効化
3. 該当月のデータを自動再取得
4. トースト通知表示
5. ダイアログ閉じる
6. ダッシュボードに新しい項目が表示される

## エラーハンドリングフロー

### クライアント側エラー
```
入力エラー → フォームバリデーション失敗
           → エラーメッセージ表示（フィールド下）
           → 送信ボタン無効化
```

### サーバー側エラー
```
バリデーションエラー → 400 Bad Request
                    → エラートースト表示
                    → ダイアログは開いたまま

サーバーエラー → 500 Internal Server Error
             → エラートースト表示
             → ログ出力（CloudWatch）
```

### ネットワークエラー
```
接続失敗 → ネットワークエラー
        → エラートースト表示
        → リトライ可能
```

## パフォーマンス最適化ポイント

1. **Optimistic Updates**: トースト通知は即座に表示
2. **Selective Invalidation**: 該当月のデータのみ再取得
3. **On-Demand Billing**: DynamoDB は使用量に応じた課金
4. **Lambda Cold Start**: 初回のみ遅延、以降は高速

## セキュリティ検証ポイント

1. **認証**: Amazon Cognito JWT検証
2. **入力検証**: クライアント + サーバー
3. **データ分離**: PK に userId を含めることで分離
4. **XSS対策**: React の自動エスケープ
